<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Biblioteca Telesecundaria Cuauhtémoc</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f0f0f0; }
    #login-box { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
    #login-box input, #login-box button { width:250px; padding:8px; margin:8px 0; border-radius:6px; border:1px solid #ccc; }
    #login-box button { background:#4CAF50; color:white; border:none; cursor:pointer; }
    #sistema { display:none; background:#f6f7fb; min-height:100vh; }
    header { background:linear-gradient(90deg,#1e40af,#2563eb); color:white; padding:18px; }
    .container { max-width:1100px; margin:auto; padding:16px; }
    .grid { display:grid; grid-template-columns:360px 1fr; gap:18px; }
    .card { background:white; padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(16,24,40,0.06); }
    label { display:block; font-size:13px; margin-top:8px; color:#6b7280; }
    input[type=text], input[type=date], input[type=number] { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #e6e9ef; box-sizing:border-box; }
    button { padding:8px 10px; border-radius:8px; border:0; background:#2463eb; color:white; cursor:pointer; }
    .small { font-size:13px; padding:6px 8px; }
    .danger { background:#ef4444; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:8px; text-align:left; border-bottom:1px solid #f1f5f9; font-size:14px; }
    #search { width:100%; padding:8px; margin-bottom:8px; border-radius:6px; border:1px solid #e6e9ef; }
    .status-available { background:#ecfdf5; color:#065f46; padding:4px 8px; border-radius:6px; font-weight:600; display:inline-block; }
    .status-loaned { background:#fff7ed; color:#92400e; padding:4px 8px; border-radius:6px; font-weight:600; display:inline-block; }
    .info-box { margin-top:12px; padding:10px; background:#f8fafc; border-radius:8px; border:1px solid #e6edf6; }
    .hidden { display:none; }
    .actions button { margin-right:6px; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-box">
  <h2>Acceso Biblioteca</h2>
  <input type="password" id="password" placeholder="Contraseña">
  <button onclick="login()">Entrar</button>
  <p id="error" style="color:red;display:none;">Contraseña incorrecta</p>
</div>

<!-- SISTEMA -->
<div id="sistema">
  <header>
    <div class="container">
      <h1>Biblioteca Telesecundaria Cuauhtémoc</h1>
      <div style="color:#e5e7eb;font-size:14px">Gestión de libros y préstamos.</div>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- Formulario de libros -->
      <div class="card">
        <strong>Agregar / Editar libro</strong>
        <form id="bookForm">
          <input type="hidden" id="bookId">
          <label>Clave</label>
          <input id="code" type="text">
          <label>Título *</label>
          <input id="title" type="text" required>
          <label>Autor</label>
          <input id="author" type="text">
          <label>Categoría *</label>
          <input id="category" type="text" required>
          <label>Cantidad</label>
          <input id="cantidad" type="number" min="1" value="1">
          <div style="margin-top:12px">
            <button type="submit">Guardar libro</button>
          </div>
        </form>
      </div>

      <!-- Lista de libros -->
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <strong>Libros</strong>
            <div class="muted">Busca por título, autor, categoría o clave.</div>
          </div>
        </div>
        <input id="search" type="text" placeholder="Buscar...">
        <table id="booksTable">
          <thead>
            <tr>
              <th>#</th><th>Clave</th><th>Título</th><th>Autor</th><th>Categoría</th><th>Estado</th><th>Acción</th>
            </tr>
          </thead>
          <tbody id="booksTbody"></tbody>
        </table>

        <!-- Panel de préstamo -->
        <div id="loanFormContainer" class="info-box hidden">
          <div id="loanHeading"><strong>Prestar libro</strong></div>
          <form id="loanForm" class="hidden">
            <input type="hidden" id="loanBookId">
            <label>Nombre del alumno *</label>
            <input id="loanName" type="text" required>
            <label>Grado *</label>
            <input id="loanGrade" type="text" required placeholder="Ej. 2">
            <label>Grupo *</label>
            <input id="loanGroup" type="text" required placeholder="Ej. B">
            <label>Fecha de devolución *</label>
            <input id="loanDueDate" type="date" required>
            <div style="margin-top:12px">
              <button type="submit">Guardar préstamo</button>
              <button type="button" id="cancelLoan" class="danger small">Cancelar</button>
            </div>
          </form>

          <div id="loanDetails" class="hidden">
            <strong>Detalles del préstamo</strong>
            <div id="loanInfo" style="margin-top:8px"></div>
            <div style="margin-top:10px;">
              <button id="returnBtn" class="small danger">Devolver libro</button>
              <button id="closeDetails" class="small">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- FIREBASE + SISTEMA -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVEtKiYTOvTqqgvI3SK5nWsCo1n9aM4Yw",
  authDomain: "biblioteca-tele-cuahutemoc.firebaseapp.com",
  projectId: "biblioteca-tele-cuahutemoc",
  storageBucket: "biblioteca-tele-cuahutemoc.firebasestorage.app",
  messagingSenderId: "591855309337",
  appId: "1:591855309337:web:c0b5453da645cba1f75088"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const booksRef = collection(db, "libros");
const loansRef = collection(db, "prestamos");

window.login = function () {
  const pass = document.getElementById("password").value;
  if (pass === "biblioteca cuahutemoc") {
    document.getElementById("login-box").style.display = "none";
    document.getElementById("sistema").style.display = "block";
    renderBooks();
  } else {
    const err = document.getElementById("error");
    err.style.display = "block";
    setTimeout(()=> err.style.display = "none", 3000);
  }
};

const bookForm = document.getElementById("bookForm");
const booksTbody = document.getElementById("booksTbody");
bookForm.addEventListener("submit", async e => {
  e.preventDefault();
  const id = document.getElementById("bookId").value;
  const clave = document.getElementById("code").value.trim();
  const titulo = document.getElementById("title").value.trim();
  const autor = document.getElementById("author").value.trim();
  const categoria = document.getElementById("category").value.trim();
  const cantidad = parseInt(document.getElementById("cantidad").value) || 1;

  if (!titulo || !categoria) return alert("Faltan campos obligatorios (Título y Categoría).");

  if (id) {
    await updateDoc(doc(db, "libros", id), { clave, titulo, autor, categoria });
  } else {
    for (let i = 0; i < cantidad; i++) {
      await addDoc(booksRef, { clave, titulo, autor, categoria, prestado: false, prestamoId: null });
    }
  }

  bookForm.reset();
  document.getElementById("cantidad").value = "1";
  document.getElementById("bookId").value = "";
  renderBooks();
});

const searchInput = document.getElementById("search");
searchInput.addEventListener("input", () => renderBooks());

async function renderBooks() {
  const booksSnapshot = await getDocs(booksRef);
  const loansSnapshot = await getDocs(loansRef);
  const loansByBook = {};
  loansSnapshot.forEach(l => {
    const data = l.data();
    if (data.bookId) loansByBook[data.bookId] = { id: l.id, ...data };
  });

  const booksArr = [];
  booksSnapshot.forEach(bDoc => {
    const b = bDoc.data();
    booksArr.push({
      id: bDoc.id, clave: b.clave || "", titulo: b.titulo || "", autor: b.autor || "",
      categoria: b.categoria || "", prestado: !!b.prestado, prestamoId: b.prestamoId || null,
      loan: loansByBook[bDoc.id] || null
    });
  });

  const q = searchInput.value.trim().toLowerCase();
  const filtered = booksArr.filter(b =>
    b.titulo.toLowerCase().includes(q) ||
    b.autor.toLowerCase().includes(q) ||
    b.categoria.toLowerCase().includes(q) ||
    b.clave.toLowerCase().includes(q)
  );

  filtered.sort((a,b) => a.categoria.localeCompare(b.categoria) || a.titulo.localeCompare(b.titulo));

  booksTbody.innerHTML = "";
  let i = 1;
  filtered.forEach(book => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i++}</td>
      <td>${escapeHtml(book.clave)}</td>
      <td>${escapeHtml(book.titulo)}</td>
      <td>${escapeHtml(book.autor)}</td>
      <td>${escapeHtml(book.categoria)}</td>
      <td>${book.prestado ? '<span class="status-loaned">Prestado</span>' : '<span class="status-available">Disponible</span>'}</td>
      <td class="actions">
        ${book.prestado
          ? `<button class="small" onclick="showLoanDetails(event,'${book.id}')">Ver préstamo</button>`
          : `<button class="small" onclick="showLoanForm(event,'${book.id}','${escapeJs(book.titulo)}')">Prestar</button>
             <button class="small" onclick="editBook(event,'${book.id}')">Editar</button>
             <button class="small danger" onclick="deleteBook(event,'${book.id}')">Eliminar</button>`}
      </td>`;
    booksTbody.appendChild(tr);
  });
}

function escapeHtml(text) {
  return text ? text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
}
function escapeJs(text) {
  return text ? text.replace(/'/g, "\\'").replace(/"/g,'\\"') : '';
}

window.deleteBook = async function(evt, id) {
  evt.stopPropagation();
  if (!confirm("¿Seguro que deseas eliminar este libro?")) return;
  await deleteDoc(doc(db, "libros", id));
  renderBooks();
};

window.editBook = async function(evt, id) {
  evt.stopPropagation();
  const snap = await getDoc(doc(db, "libros", id));
  if (!snap.exists()) return alert("Libro no encontrado.");
  const b = snap.data();
  document.getElementById("bookId").value = id;
  document.getElementById("code").value = b.clave || "";
  document.getElementById("title").value = b.titulo || "";
  document.getElementById("author").value = b.autor || "";
  document.getElementById("category").value = b.categoria || "";
  window.scrollTo({ top: 0, behavior: "smooth" });
};

// PRÉSTAMOS
document.getElementById("cancelLoan").addEventListener("click", e => {
  e.preventDefault(); hideLoanPanels();
});
function hideLoanPanels(){
  document.getElementById("loanFormContainer").classList.add("hidden");
  document.getElementById("loanForm").classList.add("hidden");
  document.getElementById("loanDetails").classList.add("hidden");
  document.getElementById("loanForm").reset();
}
const loanForm = document.getElementById("loanForm");
loanForm.addEventListener("submit", async e => {
  e.preventDefault();
  const bookId = document.getElementById("loanBookId").value;
  const nombre = document.getElementById("loanName").value.trim();
  const grado = document.getElementById("loanGrade").value.trim();
  const grupo = document.getElementById("loanGroup").value.trim();
  const fecha = document.getElementById("loanDueDate").value;
  if (!bookId || !nombre || !grado || !grupo || !fecha) return alert("Completa todos los campos del préstamo.");
  const loanDoc = await addDoc(loansRef, { bookId, nombre, grado, grupo, fechaDevolucion: fecha, creadoEn: new Date().toISOString() });
  await updateDoc(doc(db, "libros", bookId), { prestado: true, prestamoId: loanDoc.id });
  loanForm.reset(); hideLoanPanels(); renderBooks();
});
window.showLoanForm = function(evt, bookId, titulo) {
  if (evt) evt.stopPropagation();
  const c = document.getElementById("loanFormContainer");
  c.classList.remove("hidden");
  document.getElementById("loanHeading").innerText = `Prestar: ${titulo}`;
  document.getElementById("loanForm").classList.remove("hidden");
  document.getElementById("loanDetails").classList.add("hidden");
  document.getElementById("loanBookId").value = bookId;
  const dd = new Date(); dd.setDate(dd.getDate() + 7);
  document.getElementById("loanDueDate").value = dd.toISOString().slice(0,10);
};
window.showLoanDetails = async function(evt, bookId) {
  if (evt) evt.stopPropagation();
  const bSnap = await getDoc(doc(db, "libros", bookId));
  if (!bSnap.exists()) return alert("Libro no encontrado.");
  const b = bSnap.data();
  if (!b.prestado || !b.prestamoId) return alert("Este libro no está prestado.");
  const lSnap = await getDoc(doc(db, "prestamos", b.prestamoId));
  if (!lSnap.exists()) return alert("No se encontró el préstamo.");
  const l = lSnap.data();
  const c = document.getElementById("loanFormContainer");
  c.classList.remove("hidden");
  document.getElementById("loanForm").classList.add("hidden");
  document.getElementById("loanDetails").classList.remove("hidden");
  document.getElementById("loanInfo").innerHTML = `
    <div><strong>Libro:</strong> ${escapeHtml(b.titulo)}</div>
    <div><strong>Alumno:</strong> ${escapeHtml(l.nombre)}</div>
    <div><strong>Grado:</strong> ${escapeHtml(l.grado)} &nbsp; <strong>Grupo:</strong> ${escapeHtml(l.grupo)}</div>
    <div><strong>Fecha de devolución:</strong> ${escapeHtml(l.fechaDevolucion)}</div>`;
  document.getElementById("returnBtn").onclick = async () => {
    if (!confirm("¿Registrar devolución de este libro?")) return;
    await deleteDoc(doc(db, "prestamos", b.prestamoId));
    await updateDoc(doc(db, "libros", bookId), { prestado: false, prestamoId: null });
    hideLoanPanels(); renderBooks();
  };
  document.getElementById("closeDetails").onclick = () => hideLoanPanels();
};
</script>

</body>
</html>
